<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Multi-User To-Do List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4">ğŸ“ Multi-User To-Do List</h2>

    <!-- User selection -->
    <div class="d-flex align-items-center mb-3">
      <label for="userSelect" class="me-2">User:</label>
      <select id="userSelect" class="form-select w-auto me-3"></select>
      <a href="/users" class="btn btn-outline-secondary btn-sm">Manage Users</a>
    </div>

    <!-- Add Todo -->
    <form id="todoForm" class="mb-3">
      <div class="input-group">
        <input type="text" id="todoInput" class="form-control" placeholder="Enter task..." required>
        <button type="submit" class="btn btn-success">Add</button>
      </div>
    </form>

    <!-- Todo list -->
    <ul id="todoList" class="list-group"></ul>
  </div>

  <script>
    let currentUserId = null;

    // Fetch and populate users
    function loadUsers() {
      fetch('/api/users')
        .then(res => res.json())
        .then(users => {
          const select = document.getElementById('userSelect');
          select.innerHTML = '';
          users.forEach(user => {
            const opt = document.createElement('option');
            opt.value = user.id;
            opt.textContent = user.name;
            select.appendChild(opt);
          });
          if (users.length > 0) {
            currentUserId = users[0].id;
            select.value = currentUserId;
            loadTodos(currentUserId);
          }
        });
    }

    // Load todos for selected user
    function loadTodos(userId) {
      currentUserId = userId;
      fetch(`/api/todos/${userId}`)
        .then(res => res.json())
        .then(todos => {
          const list = document.getElementById('todoList');
          list.innerHTML = '';
          todos.forEach(todo => {
            const li = document.createElement('li');
            li.className = `list-group-item d-flex justify-content-between align-items-center ${todo.completed ? 'list-group-item-success' : ''}`;
            li.innerHTML = `
              <div>
                <input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleComplete(${todo.id})">
                <span class="ms-2 ${todo.completed ? 'text-decoration-line-through' : ''}">${todo.title}</span>
              </div>
              <button class="btn btn-sm btn-danger" onclick="deleteTodo(${todo.id})">ğŸ—‘</button>
            `;
            list.appendChild(li);
          });
        });
    }

    // Add a new todo
    document.getElementById('todoForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const title = document.getElementById('todoInput').value.trim();
      if (!title || !currentUserId) return;

      fetch(`/api/todos/${currentUserId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title })
      }).then(() => {
        document.getElementById('todoInput').value = '';
        loadTodos(currentUserId);
      });
    });

    // Toggle complete
    function toggleComplete(todoId) {
      fetch(`/api/todos/${todoId}/toggle`, { method: 'PUT' })
        .then(() => loadTodos(currentUserId));
    }

    // Delete todo
    function deleteTodo(todoId) {
      fetch(`/api/todos/${todoId}`, { method: 'DELETE' })
        .then(() => loadTodos(currentUserId));
    }

    // Change user
    document.getElementById('userSelect').addEventListener('change', function () {
      loadTodos(this.value);
    });

    loadUsers();
  </script>
</body>
</html>
